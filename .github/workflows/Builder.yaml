name: Builder

on:
  push:
    branches:
      - master

env:
  CMAKE_VERSION: 3.25.2
  LLVM_VERSION: 15.0.6
  NDK_VERSION: r25b

jobs:
  delete_latest_release:
    runs-on: ubuntu-latest
    steps:
    - name: checkout master
      uses: actions/checkout@master

    - name: delete latest release
      uses: dev-drprasad/delete-tag-and-release@v0.2.1
      with:
        delete_release: true
        tag_name: latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_android_arm64:
    runs-on: ubuntu-latest
    needs: delete_latest_release
    steps:
    - name: checkout master
      uses: actions/checkout@master

    - name: Kiểm tra file Cpu.h
      run: |
        ls -l /home/runner/work/Dobby/Dobby/source/core/arch/
      shell: bash

    - name: Kiểm tra file assembler
      run: |
        cat /home/runner/work/Dobby/Dobby/source/TrampolineBridge/ClosureTrampolineBridge/arm64/closure_trampoline_arm64.asm
      shell: bash

    - name: Sửa file assembler
      run: |
        sed -i 's/common_closure_bridge_handler@PAGE/common_closure_bridge_handler/g' /home/runner/work/Dobby/Dobby/source/TrampolineBridge/ClosureTrampolineBridge/arm64/closure_trampoline_arm64.asm
        sed -i 's/common_closure_bridge_handler@PAGEOFF/#:lo12:common_closure_bridge_handler/g' /home/runner/work/Dobby/Dobby/source/TrampolineBridge/ClosureTrampolineBridge/arm64/closure_trampoline_arm64.asm
      shell: bash

    - name: Kiểm tra phiên bản NDK và Clang
      run: |
        /home/runner/opt/llvm-15.0.6/bin/clang --version
        /home/runner/opt/ndk-r25b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang --version
      shell: bash

    - name: Khởi tạo môi trường biên dịch chéo Linux
      run: |
        sh scripts/setup_linux_cross_compile.sh
        mkdir -p artifact
      shell: bash

    - name: Biên dịch Android arm64
      run: |
        python3 scripts/platform_builder.py --platform=android --arch=arm64-v8a --cmake_dir=$HOME/opt/cmake-$CMAKE_VERSION --llvm_dir=$HOME/opt/llvm-$LLVM_VERSION --android_ndk_dir=$HOME/opt/ndk-$NDK_VERSION
        cp include/dobby.h build/android
        tar -zcvf build/dobby-android-arm64.tar.gz build/android
        cp build/dobby-android-arm64.tar.gz artifact/
      shell: bash

    - name: In kết quả đầu ra
      run: |
        ls -lha .
      shell: bash

    - name: Cập nhật release
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: latest
        body: "a lightweight, multi-platform, multi-architecture exploit hook framework"
        artifacts: "build/dobby-android-arm64.tar.gz"
        allowUpdates: true
        replacesArtifacts: true
